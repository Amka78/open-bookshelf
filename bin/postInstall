#!/usr/bin/env node
/**
 * Do all things that need to be done after installing packages (with bun or other package managers).
 *
 * Yes, it slows down package installation a little, but it's nice to not
 * have to remember these extra steps.
 */

// Patch any packages that need patching
run(resolvePatchPackageCommand());

// Kill the metro bundler if it's running.
if (["darwin", "linux"].includes(process.platform)) {
  run('pkill -f "[c]li.js start"', { ignoreError: true });
}

// On iOS, make sure CocoaPods are installed
if (process.platform === "darwin") {
  run('if [ -d "ios" ]; then cd ios && pod install && cd -; fi');
}

// Run baby run
function run(command, options = {}) {
  const { ignoreError = false } = options;
  console.log(`./bin/postInstall script running: ${command}`);

  try {
    require("child_process").execSync(command, { stdio: "inherit" });
  } catch (error) {
    if (ignoreError) {
      return;
    }

    console.error(`./bin/postInstall failed on command:\n  ${command}`);
    process.exit(error.status);
  }
}

function resolvePatchPackageCommand() {
  if (hasCommand("bunx")) {
    return "bunx patch-package";
  }

  if (hasCommand("npx")) {
    return "npx --yes patch-package";
  }

  return "./node_modules/.bin/patch-package";
}

function hasCommand(command) {
  try {
    require("child_process").execSync(`command -v ${command}`, {
      stdio: "ignore",
    });
    return true;
  } catch (_) {
    return false;
  }
}
